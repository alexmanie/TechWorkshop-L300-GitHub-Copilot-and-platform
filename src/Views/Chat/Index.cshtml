@{
    ViewData["Title"] = "Chat";
}

<div class="container mt-4">
    <h1 class="mb-4">Chat with Phi-4</h1>

    <div class="mb-3">
        <textarea id="conversation" class="form-control" rows="15" readonly
                  style="resize: none; background-color: #f8f9fa;"></textarea>
    </div>

    <div class="input-group">
        <input type="text" id="userMessage" class="form-control" placeholder="Type your message..."
               aria-label="User message" />
        <button id="sendBtn" class="btn btn-primary" type="button">Send</button>
    </div>
</div>

@section Scripts {
    <script>
        const conversationArea = document.getElementById('conversation');
        const userMessageInput = document.getElementById('userMessage');
        const sendBtn = document.getElementById('sendBtn');

        function appendMessage(prefix, text) {
            if (conversationArea.value.length > 0) {
                conversationArea.value += '\n\n';
            }
            conversationArea.value += prefix + text;
            conversationArea.scrollTop = conversationArea.scrollHeight;
        }

        async function sendMessage() {
            const message = userMessageInput.value.trim();
            if (!message) return;

            appendMessage('You: ', message);
            userMessageInput.value = '';
            sendBtn.disabled = true;

            try {
                const response = await fetch('@Url.Action("Send", "Chat")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ message })
                });

                if (response.ok) {
                    const reply = await response.text();
                    appendMessage('Phi-4: ', reply);
                } else {
                    appendMessage('Error: ', 'Failed to get a response. Please try again.');
                }
            } catch (e) {
                appendMessage('Error: ', 'An unexpected error occurred.');
            } finally {
                sendBtn.disabled = false;
                userMessageInput.focus();
            }
        }

        sendBtn.addEventListener('click', sendMessage);

        userMessageInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
}
